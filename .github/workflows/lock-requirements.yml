name: Lock requirements + liboqs & liboqs-python SHA256

on:
  workflow_dispatch:
  push:
    paths:
      - requirements.in

jobs:
  lock:
    runs-on: ubuntu-latest

    container:
      image: python:3.12-slim

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install pip-tools and utilities
        run: |
          apt-get update && apt-get install -y curl ca-certificates
          python -m pip install --upgrade pip
          pip install pip-tools

      - name: Generate hash-locked requirements
        run: |
          pip-compile \
            --generate-hashes \
            --resolver=backtracking \
            --output-file requirements.txt \
            requirements.in

      - name: Compute liboqs SHA256
        env:
          LIBOQS_VERSION: "0.14.0"
        run: |
          curl -fsSL -o /tmp/liboqs.tar.gz \
            "https://github.com/open-quantum-safe/liboqs/archive/refs/tags/${LIBOQS_VERSION}.tar.gz"
          sha256oqs=$(sha256sum /tmp/liboqs.tar.gz | awk '{print $1}')
          echo "LIBOQS_SHA256=${sha256oqs}" >> sha_values.env

      - name: Compute liboqs-python SHA256
        env:
          LIBOQS_PY_VERSION: "0.12.0"
        run: |
          curl -fsSL -o /tmp/liboqs-python.tar.gz \
            "https://github.com/open-quantum-safe/liboqs-python/archive/refs/tags/${LIBOQS_PY_VERSION}.tar.gz"
          sha256oqspython=$(sha256sum /tmp/liboqs-python.tar.gz | awk '{print $1}')
          echo "LIBOQSPYTHON_SHA256=${sha256oqspython}" >> sha_values.env

      - name: Prepend SHAs into requirements.txt
        run: |
          source sha_values.env
          {
            echo "# liboqs_version=0.14.0"
            echo "# liboqs_tarball_sha256=${LIBOQS_SHA256}"
            echo "# liboqs-python_version=0.12.0"
            echo "# liboqs-python_tarball_sha256=${LIBOQSPYTHON_SHA256}"
            echo
            cat requirements.txt
          } > requirements_with_shas.txt
          mv requirements_with_shas.txt requirements.txt

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: requirements-locked-with-shas
          path: requirements.txt
