name: Lock requirements + liboqs SHA256s

on:
  workflow_dispatch:
  push:
    paths:
      - requirements.in

jobs:
  lock:
    runs-on: ubuntu-latest

    container:
      image: python:3.12-slim

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install system tools
        run: |
          set -e
          apt-get update
          apt-get install -y --no-install-recommends \
            curl \
            ca-certificates \
            coreutils
          rm -rf /var/lib/apt/lists/*

      - name: Install pip-tools
        run: |
          set -e
          python -m pip install --upgrade pip
          pip install pip-tools

      - name: Generate hash-locked requirements.txt
        run: |
          set -e
          pip-compile \
            --generate-hashes \
            --resolver=backtracking \
            --output-file requirements.txt \
            requirements.in

      - name: Compute liboqs SHA256
        run: |
          set -e
          LIBOQS_VERSION="0.14.0"
          curl -fsSL -o /tmp/liboqs.tar.gz \
            "https://github.com/open-quantum-safe/liboqs/archive/refs/tags/${LIBOQS_VERSION}.tar.gz"
          LIBOQS_SHA256="$(sha256sum /tmp/liboqs.tar.gz | awk '{print $1}')"

          echo "LIBOQS_VERSION=${LIBOQS_VERSION}" >> "$GITHUB_ENV"
          echo "LIBOQS_SHA256=${LIBOQS_SHA256}" >> "$GITHUB_ENV"

      - name: Compute liboqs-python SHA256
        run: |
          set -e
          LIBOQS_PY_VERSION="0.12.0"
          curl -fsSL -o /tmp/liboqs-python.tar.gz \
            "https://github.com/open-quantum-safe/liboqs-python/archive/refs/tags/${LIBOQS_PY_VERSION}.tar.gz"
          LIBOQS_PY_SHA256="$(sha256sum /tmp/liboqs-python.tar.gz | awk '{print $1}')"

          echo "LIBOQS_PY_VERSION=${LIBOQS_PY_VERSION}" >> "$GITHUB_ENV"
          echo "LIBOQS_PY_SHA256=${LIBOQS_PY_SHA256}" >> "$GITHUB_ENV"

      - name: Prepend SHAs into requirements.txt
        run: |
          set -e
          {
            echo "# liboqs_version=${LIBOQS_VERSION}"
            echo "# liboqs_tarball_sha256=${LIBOQS_SHA256}"
            echo "# liboqs_python_version=${LIBOQS_PY_VERSION}"
            echo "# liboqs_python_tarball_sha256=${LIBOQS_PY_SHA256}"
            echo "# generated_by=github_actions_pip_compile"
            echo
            cat requirements.txt
          } > requirements.tmp
          mv requirements.tmp requirements.txt

      - name: Upload locked requirements.txt artifact
        uses: actions/upload-artifact@v4
        with:
          name: requirements-locked-with-shas
          path: requirements.txt
          retention-days: 30
